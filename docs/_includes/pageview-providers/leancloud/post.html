{%- include snippets/get-sources.html -%}
{%- assign _sources = __return -%}

{%- assign _LEANCLOUD_APP_ID = site.pageview.leancloud.app_id -%}
{%- assign _LEANCLOUD_APP_KEY = site.pageview.leancloud.app_key -%}
{%- assign _LEANCLOUD_APP_CLASS = site.pageview.leancloud.app_class -%}

{%- if page.key and
  _LEANCLOUD_APP_ID and
  _LEANCLOUD_APP_KEY and
  _LEANCLOUD_APP_CLASS -%}

  <script>
    // {%- include pageview-providers/leancloud/leancloud.js -%}
  </script>
  <script id="leancloud-script-post" data-app-id="{{ _LEANCLOUD_APP_ID }}" data-app-key="{{ _LEANCLOUD_APP_KEY }}" data-app-class="{{ _LEANCLOUD_APP_CLASS }}" data-title="{{ page.title | escape }}" data-key="{{ page.key | escape }}">
    // @ts-nocheck
    window.Lazyload.js(['{{ _sources.jquery }}', '{{ _sources.leancloud_js_sdk }}'], function() {
      var script = document.getElementById('leancloud-script-post');
      var appId = script.getAttribute('data-app-id');
      var appKey = script.getAttribute('data-app-key');
      var appClass = script.getAttribute('data-app-class');
      var title = script.getAttribute('data-title');
      var key = script.getAttribute('data-key');

      var pageview = window.pageview(AV, {
        appId:    appId,
        appKey:   appKey,
        appClass: appClass
      });
      pageview.increase(key, title, function(view) {
        $("[data-page-key='" + key + "']").text(view);
      });
    });
  </script>

{%- endif -%}